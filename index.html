<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta UVIS - SP</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { background-color: #f4f6f9; }
        .main-card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        #map { height: 80vh; width: 100%; border-radius: 8px; border: 1px solid #dee2e6; }
        
        /* Estilo para a caixa de endere칞o (fixa) */
        .address-box {
            background: #e9ecef;
            border-left: 4px solid #6c757d;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        /* Estilo para a caixa de territ칩rio (din칙mica) */
        .territory-box {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #0d6efd;
        }

        .data-row {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #eee;
        }
        .data-row:last-child { border-bottom: none; }

        .res-label { font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 700; display: block; }
        .res-value { font-size: 0.95rem; color: #212529; font-weight: 600; word-break: break-word; }
        
        /* Bloco de texto longo (email/obs) */
        .long-text-block {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: pre-wrap;
            margin-top: 5px;
            border: 1px solid #eee;
        }

        .btn-copy { 
            cursor: pointer; 
            color: #6c757d; 
            float: right;
            transition: 0.2s;
        }
        .btn-copy:hover { color: #0d6efd; }
    </style>
</head>
<body class="py-4">

<div class="container-fluid px-4">
    <div class="text-center mb-4">
        <h3 class="fw-bold text-primary">游늸 Localizador UVIS e DA</h3>
        <p class="text-muted small">Prefeitura de S칚o Paulo - Consulta de Territ칩rio</p>
    </div>

    <div class="row g-4">
        <div class="col-md-4 col-lg-3">
            
            <div class="card main-card mb-3">
                <div class="card-body">
                    <div class="mb-2">
                        <label class="form-label small fw-bold text-secondary">CEP</label>
                        <input type="text" class="form-control" id="cep" placeholder="00000-000" maxlength="9">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-8">
                            <label class="form-label small fw-bold text-secondary">Logradouro *</label>
                            <input type="text" class="form-control" id="logradouro" placeholder="Nome da rua">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold text-secondary">N칰mero</label>
                            <input type="text" class="form-control" id="numero" placeholder="N췈">
                        </div>
                    </div>
                    <button class="btn btn-primary w-100 fw-bold mt-2" onclick="buscarEndereco()">游댌 CONSULTAR</button>
                </div>
            </div>

            <div id="loading" class="text-center d-none py-3">
                <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                <span class="ms-2 small text-muted">Processando...</span>
            </div>

            <div id="results-area" class="d-none animate__animated animate__fadeIn">
                
                <h6 class="fw-bold text-secondary small mb-2">游늸 ENDERE칂O LOCALIZADO</h6>
                <div class="address-box">
                    <div class="data-row">
                        <span class="res-label">Logradouro</span>
                        <span id="addr-log" class="res-value">-</span>
                    </div>
                    <div class="data-row">
                        <span class="res-label">Bairro / CEP</span>
                        <span id="addr-bairro-cep" class="res-value">-</span>
                    </div>
                </div>

                <h6 class="fw-bold text-primary small mb-2">游낀 DADOS DO TERRIT칍RIO (UVIS/DA)</h6>
                <div class="territory-box">
                    <div class="data-row">
                        <span class="res-label">UVIS (Unidade de Vigil칙ncia)</span>
                        <span id="terr-uvis" class="res-value">-</span>
                         <span class="btn-copy" onclick="copiar('terr-uvis')" title="Copiar">游늶</span>
                    </div>
                    
                    <div class="data-row">
                        <span class="res-label">DA (Distrito Administrativo)</span>
                        <span id="terr-da" class="res-value">-</span>
                        <span class="btn-copy" onclick="copiar('terr-da')" title="Copiar">游늶</span>
                    </div>

                    <div class="mt-3">
                        <span class="res-label">Contatos e Detalhes Completos:</span>
                        <div id="terr-full-info" class="long-text-block">-</div>
                        <div class="text-end mt-1">
                             <button class="btn btn-sm btn-outline-secondary" onclick="copiar('terr-full-info')">Copiar Tudo</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        
        <div class="col-md-8 col-lg-9">
            <div id="map"></div>
            <p class="text-muted small mt-2 text-end">
                <span class="badge bg-light text-dark border">Dica</span> Clique em qualquer regi칚o colorida para ver os dados detalhados na lateral.
            </p>
        </div>
    </div>
    
    <footer class="text-center mt-5 mb-4">
        <hr class="w-50 mx-auto text-secondary" style="opacity: 0.2;">
        <p class="small text-muted">
            Ferramenta de consulta territorial - Prefeitura de SP<br>
            <a href="privacidade.html" class="text-decoration-none text-primary fw-bold">Pol칤tica de Privacidade</a>
        </p>
    </footer>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
    const map = L.map('map').setView([-23.5505, -46.6333], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    let geoJsonData = null;
    let marker = null;
    let bairroCache = "";
    let geoJsonLayer = null;

    // Cores distintas para as regi칫es
    const distinctColors = [
        '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', 
        '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', 
        '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', 
        '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'
    ];

    function getColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % distinctColors.length;
        return distinctColors[index];
    }

    function styleFeature(feature) {
        let nomeParaCor = "default";
        // Procura alguma propriedade UVIS para definir a cor
        for (const [key, value] of Object.entries(feature.properties)) {
            if (key.toLowerCase().includes('uvis')) {
                nomeParaCor = value;
                break;
            }
        }
        const baseColor = getColor(String(nomeParaCor));
        return {
            fillColor: baseColor,
            weight: 2,
            opacity: 1,
            color: baseColor,
            dashArray: '',
            fillOpacity: 0.1 
        };
    }

    function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({ weight: 4, fillOpacity: 0.3 });
        layer.bringToFront();
        if (marker) marker.setZIndexOffset(1000);
    }

    function resetHighlight(e) {
        geoJsonLayer.resetStyle(e.target);
    }

    // --- L칍GICA DE CLIQUE NO MAPA ---
    function onFeatureClick(e) {
        map.fitBounds(e.target.getBounds());
        // Atualiza APENAS a caixa de territ칩rio
        atualizarBlocoTerritorio(e.target.feature.properties);
        
        // Garante que a 치rea de resultados esteja vis칤vel
        document.getElementById('results-area').classList.remove('d-none');
    }

    function onEachFeature(feature, layer) {
        // Tooltip simples com nome ao passar o mouse
        let nomeTooltip = "";
        for (const [key, value] of Object.entries(feature.properties)) {
            if (key.toLowerCase().includes('uvis')) {
                nomeTooltip = value;
                break;
            }
        }
        if(nomeTooltip) {
            layer.bindTooltip(nomeTooltip, { permanent: false, direction: "center", className: "bg-light text-dark border px-1" });
        }

        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: onFeatureClick
        });
    }

    // --- CARREGAMENTO INICIAL ---
    fetch('./dados.json')
        .then(response => response.json())
        .then(data => {
            geoJsonData = data;
            geoJsonLayer = L.geoJson(data, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);

            if(geoJsonLayer.getBounds().isValid()){
                map.fitBounds(geoJsonLayer.getBounds());
            }
            console.log("Base carregada.");
        })
        .catch(err => {
            console.error(err);
            alert("Erro ao carregar 'dados.json'.");
        });

    // --- BUSCA DE CEP ---
    document.getElementById('cep').addEventListener('blur', function() {
        let cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        bairroCache = data.bairro;
                    }
                });
        }
    });

    // --- FUN칂츾O DE CONSULTA PRINCIPAL ---
    function buscarEndereco() {
        const rua = document.getElementById('logradouro').value;
        const num = document.getElementById('numero').value;
        const cepVal = document.getElementById('cep').value;

        if (!rua) { alert("Preencha o logradouro."); return; }

        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('results-area').classList.add('d-none');

        const query = `${rua}, ${num}, S칚o Paulo, Brasil`;
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}&limit=1`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('d-none');
                
                if (data.length > 0) {
                    // 1. Atualiza Bloco de Endere칞o (Fixo)
                    const enderecoCompleto = rua + (num ? `, ${num}` : '');
                    let bairroFinal = bairroCache || (data[0].address ? (data[0].address.suburb || data[0].address.neighbourhood || "N칚o identificado") : "-");
                    let cepFinal = cepVal || (data[0].address ? data[0].address.postcode : "-");

                    document.getElementById('addr-log').innerText = enderecoCompleto;
                    document.getElementById('addr-bairro-cep').innerText = `${bairroFinal} - ${cepFinal}`;

                    // 2. Atualiza Mapa e Territ칩rio
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    if (marker) map.removeLayer(marker);
                    marker = L.marker([lat, lon], { draggable: true }).addTo(map);
                    marker.setZIndexOffset(1000);
                    map.setView([lat, lon], 16);
                    
                    // Se o pino for arrastado, recalcula s칩 o territ칩rio
                    marker.on('dragend', function(e) {
                        verificarPoligono(e.target.getLatLng().lat, e.target.getLatLng().lng);
                    });

                    // Verifica onde caiu
                    verificarPoligono(lat, lon);
                    
                    document.getElementById('results-area').classList.remove('d-none');

                } else {
                    alert("Endere칞o n칚o encontrado.");
                }
            })
            .catch(() => {
                document.getElementById('loading').classList.add('d-none');
                alert("Erro de conex칚o.");
            });
    }

    // --- FUN칂칏ES AUXILIARES DE TERRIT칍RIO ---
    function verificarPoligono(lat, lon) {
        if (!geoJsonData) return;
        const ponto = turf.point([lon, lat]);
        
        let encontrou = false;
        turf.featureEach(geoJsonData, function (feat) {
            if (turf.booleanPointInPolygon(ponto, feat)) {
                atualizarBlocoTerritorio(feat.properties);
                encontrou = true;
            }
        });

        if (!encontrou) {
            document.getElementById('terr-uvis').innerText = "Fora da 치rea mapeada";
            document.getElementById('terr-da').innerText = "-";
            document.getElementById('terr-full-info').innerText = "-";
        }
    }

    function atualizarBlocoTerritorio(props) {
        let uvis = "-", da = "-";
        let fullInfo = [];

        // Varre todas as propriedades para montar o bloco
        for (const [key, value] of Object.entries(props)) {
            const k = key.toLowerCase();
            const val = String(value).trim();
            
            // Identifica UVIS e DA para destaque
            if (k.includes('uvis') && !k.includes('cod') && !k.includes('id') && !k.includes('end') && !k.includes('tel')) {
                 uvis = val;
            }
            if ((k.includes('da') || k.includes('distrito')) && !k.includes('cod') && !k.includes('id')) {
                 da = val;
            }

            // Adiciona tudo ao "bloc칚o" de detalhes
            // Formato: Chave: Valor
            if (val && val !== "null" && val !== "undefined") {
                 fullInfo.push(`${key}: ${val}`);
            }
        }

        document.getElementById('terr-uvis').innerText = uvis;
        document.getElementById('terr-da').innerText = da;
        document.getElementById('terr-full-info').innerText = fullInfo.join("\n");
    }

    function copiar(elementId) {
        const texto = document.getElementById(elementId).innerText;
        navigator.clipboard.writeText(texto).then(() => {
            // Feedback visual r치pido
            alert("Copiado!"); 
        });
    }
</script>

</body>
</html>
