<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Territ√≥rio UVIS e UBS</title>
    <meta name="description" content="Localizador de UVIS, Distrito Administrativo e UBS de refer√™ncia em S√£o Paulo.">
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="./icon.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f4f6f9; }
        .main-card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #map { height: 85vh; width: 100%; border-radius: 8px; border: 1px solid #dee2e6; }
        .result-row { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e9ecef; padding: 6px 10px; border-radius: 6px; margin-bottom: 6px; }
        .res-label { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; font-weight: 700; display: block; }
        .res-value { font-size: 0.95rem; color: #212529; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .res-value-multiline { font-size: 0.85rem; color: #212529; font-weight: 600; white-space: pre-wrap; word-break: break-word; line-height: 1.4; }
        .detail-card { background-color: #fff; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-top: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #6610f2; }
        .detail-title { font-size: 0.9rem; font-weight: 700; color: #6610f2; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .detail-content { font-size: 0.8rem; color: #333; line-height: 1.6; }
        .btn-copy { background-color: #f8f9fa; border: 1px solid #dee2e6; color: #495057; width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; margin-left: 8px; flex-shrink: 0; }
        .btn-copy:hover { background-color: #e2e6ea; color: #0d6efd; border-color: #cbd5e0; }
        .btn-copy.copied { background-color: #198754; color: white; border-color: #198754; }
        .border-uvis { border-left: 3px solid #0d6efd; }
        .border-da { border-left: 3px solid #198754; }
        #toggle-view-btn { position: fixed; bottom: 20px; right: 20px; z-index: 2000; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); display: none; font-size: 1.5rem; border: none; }
        
        /* Estilos do Modal */
        .list-group-item-action { cursor: pointer; font-size: 0.9rem; border-left: 3px solid transparent; }
        .list-group-item-action:hover { background-color: #f8f9fa; color: #0d6efd; border-left: 3px solid #0d6efd; }
        .badge-bairro { font-size: 0.7rem; background-color: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 4px; margin-left: 5px; text-transform: uppercase; font-weight: 700; }
        .badge-numero { font-size: 0.7rem; background-color: #198754; color: white; padding: 2px 6px; border-radius: 4px; margin-right: 5px; }

        @media (max-width: 768px) {
            #toggle-view-btn { display: flex; align-items: center; justify-content: center; }
            footer { display: none !important; }
            .col-md-3 { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(244, 246, 249, 0.98); z-index: 1500; padding-top: 10px; transition: transform 0.3s ease; }
            .col-md-3.hidden { display: none !important; }
        }
    </style>
</head>
<body class="py-3">

<div class="modal fade" id="modalSelecao" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light py-2">
        <h6 class="modal-title fw-bold text-primary">üìç Encontramos op√ß√µes similares</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <div class="alert alert-warning small m-2 p-2">
            <i class="bi bi-exclamation-triangle"></i> Selecione o endere√ßo que corresponde √† sua Cidade/Bairro:
        </div>
        <div class="list-group list-group-flush" id="lista-enderecos"></div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid px-3">
    <div class="row g-3">
        <div class="col-md-3 d-flex flex-column" style="max-height: 95vh; overflow-y: auto;">
            <div class="text-center mb-3">
                <h5 class="fw-bold text-primary mb-0">Localizador UVIS SP</h5>
            </div>

            <div class="card main-card mb-3">
                <div class="card-body p-3">
                    <div class="mb-2">
                        <label class="form-label small fw-bold text-secondary mb-1">CEP</label>
                        <input type="text" class="form-control form-control-sm" id="cep" placeholder="00000-000" maxlength="9">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-8">
                            <label class="form-label small fw-bold text-secondary mb-1">Logradouro</label>
                            <input type="text" class="form-control form-control-sm" id="logradouro" placeholder="Nome da rua">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold text-secondary mb-1">N√∫mero</label>
                            <input type="text" class="form-control form-control-sm" id="numero" placeholder="N¬∫">
                        </div>
                    </div>
                    
                    <button id="btn-buscar" class="btn btn-primary btn-sm w-100 fw-bold" onclick="buscarEndereco()">
                        <i class="bi bi-search"></i> CONSULTAR
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 fw-bold mt-2" onclick="limparTudo()">
                        LIMPAR TUDO
                    </button>
                </div>
            </div>

            <div id="search-results" class="d-none animate__animated animate__fadeIn">
                <h6 class="fw-bold text-secondary small mb-2">ENDERE√áO LOCALIZADO</h6>
                <div class="result-row border-uvis">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">UVIS (Refer√™ncia)</span>
                        <span id="res-uvis" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-uvis')">üìã</button>
                </div>
                <div class="result-row border-da">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Distrito Administrativo</span>
                        <span id="res-da" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-da')">üìã</button>
                </div>
                <div id="ubs-result-card" class="d-none mb-2 p-2 bg-white border border-success rounded shadow-sm" style="border-left-width: 5px !important;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="res-label text-success">üè• UBS de Refer√™ncia</span>
                            <div id="res-ubs" class="fw-bold text-success" style="font-size: 0.9rem;">-</div>
                        </div>
                        <button class="btn-copy" onclick="copiar(this, 'res-ubs')">üìã</button>
                    </div>
                </div>
                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Endere√ßo Pesquisado</span>
                        <span id="res-log" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-log')">üìã</button>
                </div>
                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Bairro</span>
                        <span id="res-bairro" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-bairro')">üìã</button>
                </div>
                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">CEP</span>
                        <span id="res-cep" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-cep')">üìã</button>
                </div>
                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Cidade</span>
                        <span id="res-cidade" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-cidade')">üìã</button>
                </div>
                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Contatos / Email</span>
                        <span id="res-email" class="res-value-multiline">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-email')">üìã</button>
                </div>
            </div>

            <div id="region-details" class="detail-card d-none animate__animated animate__fadeInUp">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="detail-title mb-0">FICHA T√âCNICA DA UNIDADE</span>
                    <button class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.7rem;" onclick="copiarTextoDetalhes(this)">Copiar Tudo</button>
                </div>
                <div id="detail-content" class="detail-content">-</div>
            </div>

            <footer class="mt-auto py-3 text-center">
                <div class="d-flex justify-content-center gap-3 mb-2">
                    <a href="https://chromewebstore.google.com/detail/ohhkpccnilhbbhgeidmajpghpjgpipcc?utm_source=item-share-cb" target="_blank" class="small text-muted text-decoration-none"> Extens√£o</a>
                    <span class="text-muted small">‚Ä¢</span>
                    <a href="privacidade.html" class="small text-muted text-decoration-none"> Privacidade</a>
                </div>
                <div class="small">
                    <a href="https://github.com/wellingtonlb/consulta-uvis" target="_blank" class="text-muted text-decoration-none opacity-75"></> &lt;/&gt; C√≥digo Fonte</a>
                </div>
            </footer>
        </div>
        
        <div class="col-md-9">
            <div id="map"></div>
            <p class="text-muted small mt-1 text-end mb-0">
                <span class="badge bg-light text-dark border">Dica</span> Arraste o pino para ajustar. Clique em qualquer √°rea colorida para ver a ficha.
            </p>
        </div>
    </div>
</div>

<button id="toggle-view-btn" class="btn btn-primary" onclick="alternarVisualizacao()">üó∫Ô∏è</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js').then(reg => reg.update()).catch(console.error);
        });
    }

    const map = L.map('map').setView([-23.5505, -46.6333], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap ¬© CARTO' }).addTo(map);

    let geoJsonData = null, geoJsonUBS = null, marker = null, geoJsonLayer = null;
    let modalSelecao = null; 

    const distinctColors = ['#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'];
    function getColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
        return distinctColors[Math.abs(hash) % distinctColors.length];
    }
    function styleFeature(feature) {
        let nome = "default";
        for (const [key, value] of Object.entries(feature.properties)) if (key.toLowerCase().includes('uvis')) { nome = value; break; }
        return { fillColor: getColor(String(nome)), weight: 1, opacity: 1, color: '#888', fillOpacity: 0.1 };
    }
    function onEachFeature(feature, layer) {
        let nome = "";
        for (const [key, value] of Object.entries(feature.properties)) if (key.toLowerCase().includes('uvis')) { nome = value; break; }
        layer.bindTooltip(nome, { permanent: false, direction: "center", className: "bg-transparent border-0 text-dark fw-bold" });
        layer.on({
            mouseover: (e) => { e.target.setStyle({ weight: 3, color: '#666', fillOpacity: 0.3 }); e.target.bringToFront(); if (marker) marker.setZIndexOffset(1000); },
            mouseout: (e) => geoJsonLayer.resetStyle(e.target),
            click: (e) => { limparDadosVisuais(); document.getElementById('res-log').innerText = "Selecionado no Mapa"; atualizarMapa(e.latlng.lat, e.latlng.lng, false); }
        });
    }

    fetch('./Territ√≥rios_UVIS.geojson').then(r => { if(!r.ok) throw new Error("404"); return r.json(); }).then(data => carregarUVIS(data)).catch(() => { fetch('./dados.json').then(r => r.json()).then(data => carregarUVIS(data)).catch(console.error); });
    function carregarUVIS(data) { geoJsonData = data; geoJsonLayer = L.geoJson(data, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map); if(geoJsonLayer.getBounds().isValid()) map.fitBounds(geoJsonLayer.getBounds()); }
    fetch('./Territorios_UBS.geojson').then(r => r.json()).then(data => geoJsonUBS = data).catch(console.warn);

    function limparDadosVisuais() {
        ['res-log','res-cep','res-bairro','res-cidade','res-uvis','res-da','res-ubs','res-email'].forEach(id => document.getElementById(id).innerText = "-");
        ['search-results','region-details','ubs-result-card'].forEach(id => document.getElementById(id).classList.add('d-none'));
    }

    function limparTudo() {
        ['cep','logradouro','numero'].forEach(id => document.getElementById(id).value = '');
        limparDadosVisuais();
        if (marker) { map.removeLayer(marker); marker = null; }
        map.setView([-23.5505, -46.6333], 11);
    }

    function limparLogradouro(nome) {
        const termos = ["rua", "avenida", "av\\.", "av", "travessa", "tv\\.", "tv", "alameda", "al\\.", "al", "pra√ßa", "praca", "p√ß", "viela", "largo", "estrada", "rodovia", "doutor", "dr\\.", "dr", "dra\\.", "dra", "professor", "prof\\.", "prof", "profa\\.", "profa", "tenente", "ten\\.", "ten", "coronel", "cel\\.", "cel", "major", "maj\\.", "maj", "capit√£o", "capitao", "cap\\.", "cap", "general", "gen\\.", "gen", "almirante", "alm\\.", "alm", "brigadeiro", "brig\\.", "brig", "marechal", "mar\\.", "mar", "sargento", "sgt\\.", "sgt", "governador", "gov\\.", "gov", "presidente", "pres\\.", "pres", "deputado", "dep\\.", "dep", "senador", "sen\\.", "sen", "padre", "pe\\.", "pe", "bispo", "dom", "freira", "irm√£", "irma", "engenheiro", "eng\\.", "eng", "arquiteto", "arq\\.", "arq"];
        const regex = new RegExp(`\\b(${termos.join("|")})\\b`, "gi");
        return nome.replace(regex, "").replace(/\s+/g, " ").trim();
    }

    function obterCidade(addr) { return addr.city || addr.town || addr.municipality || addr.village || addr.county || "S√£o Paulo"; }

    async function preencherEnderecoPeloCEP(cep) {
        const logradouroInput = document.getElementById('logradouro');
        try {
            logradouroInput.placeholder = "Carregando...";
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/?_=${new Date().getTime()}`);
            const data = await response.json();
            if (!data.erro) {
                logradouroInput.value = data.logradouro;
                document.getElementById('res-bairro').innerText = data.bairro;
                document.getElementById('res-cidade').innerText = data.localidade;
                document.getElementById('res-cep').innerText = cep.replace(/^(\d{5})(\d)/, '$1-$2');
                document.getElementById('numero').focus();
            } else {
                alert("‚ùå CEP n√£o encontrado!");
                logradouroInput.placeholder = "Nome da rua";
            }
        } catch { logradouroInput.placeholder = "Nome da rua"; }
    }

    async function buscarEndereco() {
         const mapboxToken = 'pk.eyJ1Ijoid2xidyIsImEiOiJjbWxqa2ZoYzcwMHF3M2dweDY0ZTJyOG5xIn0.MTxGN6qYDDpBJXtkXr1gNw'; 
        
        limparDadosVisuais();

         let logradouro = document.getElementById('logradouro').value.trim();
        let numero = document.getElementById('numero').value.trim();
        let cepInputVal = document.getElementById('cep').value.replace(/\D/g, '');
        
         let bairroOficial = "-";
        let cidadeViaCEP = ""; 
        let cepOficial = "-";

         if (cepInputVal.length === 8) {
            try {
                if (logradouro === "") document.getElementById('logradouro').placeholder = "Carregando...";
                const response = await fetch(`https://viacep.com.br/ws/${cepInputVal}/json/?_=${new Date().getTime()}`);
                const data = await response.json();
                if (!data.erro) {
                     if(logradouro === "") {
                        logradouro = data.logradouro; 
                        document.getElementById('logradouro').value = data.logradouro;
                    }
                    bairroOficial = data.bairro;
                    cidadeViaCEP = data.localidade;  
                    cepOficial = cepInputVal.replace(/^(\d{5})(\d)/, '$1-$2');
                } else if (logradouro === "") { alert("‚ùå CEP n√£o encontrado!"); return; }
            } catch (error) { console.error("Erro ViaCEP:", error); }
        }

        if (logradouro === "") { alert("‚ö†Ô∏è Digite o Nome da Rua."); return; }

         let query = `${logradouro}`;
        if (numero !== "") query += `, ${numero}`;
        
 
        const cidadeFinal = cidadeViaCEP || "S√£o Paulo";
        query += `, ${cidadeFinal}, Brazil`;

        const queryEncoded = encodeURIComponent(query);

    
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${queryEncoded}.json?access_token=${mapboxToken}&country=br&proximity=-46.6333,-23.5505&types=address&limit=1`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.features && data.features.length > 0) {
                const resultado = data.features[0];
                const [lon, lat] = resultado.center;  
                
                 console.log("Precis√£o:", resultado.properties.accuracy || "N/A", "| Local:", resultado.place_name);

                 document.getElementById('res-log').innerText = resultado.place_name.split(',')[0]; // S√≥ o nome da rua para ficar limpo
                
                 if(bairroOficial !== "-") {
                     document.getElementById('res-bairro').innerText = bairroOficial;
                     document.getElementById('res-cidade').innerText = cidadeViaCEP;
                     document.getElementById('res-cep').innerText = cepOficial;
                } else {
                     const context = resultado.context || [];
                    const bairroObj = context.find(c => c.id.includes('neighborhood'));
                    const cidadeObj = context.find(c => c.id.includes('place'));
                    if(bairroObj) document.getElementById('res-bairro').innerText = bairroObj.text;
                    if(cidadeObj) document.getElementById('res-cidade').innerText = cidadeObj.text;
                }

                atualizarMapa(lat, lon, true);
                verificarPoligono(lat, lon);

            } else {
                alert("‚ùå Endere√ßo n√£o localizado com precis√£o.");
            }
        } catch (error) {
            console.error("Erro na busca da API:", error);
            alert("Erro de conex√£o com o mapa.");
        }
    }


        function fazerBuscaFlexivel(nomeRua, permitirSanitizacao) {
            let q = `${nomeRua}`;
            if (numero !== "") q += `, ${numero}`;
            const cidadeAlvo = cidadeViaCEP || "S√£o Paulo";
            q += `, ${cidadeAlvo}, Brazil`;
            const p = new URLSearchParams({ q: q });
            if (cidadeAlvo === "S√£o Paulo") { p.set('viewbox', '-47.20,-23.10,-46.10,-24.00'); p.set('bounded', '1'); }

            fetch(urlBase + p.toString() + commonParams)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) { if (processarResultados(data)) return; }
                    if (permitirSanitizacao) {
                        const nomeLimpo = limparLogradouro(logradouro);
                        if (nomeLimpo !== logradouro && nomeLimpo.length > 3) fazerBuscaFlexivel(nomeLimpo, false);
                        else alert("Endere√ßo n√£o localizado.");
                    } else { alert("Endere√ßo n√£o localizado."); }
                })
                .catch(() => alert("Erro de conex√£o."));
        }

        function carregarResultadoNoMapa(item) {
            let lat = parseFloat(item.lat);
            let lon = parseFloat(item.lon);
            const addr = item.address;

            const bairroMapa = addr.suburb || addr.neighbourhood || addr.city_district || "-";
            const cidadeMapa = obterCidade(addr);
            
            let cepInputVal = document.getElementById('cep').value.replace(/\D/g, '');
            let cepFormatado = cepInputVal.length === 8 ? cepInputVal.replace(/^(\d{5})(\d)/, '$1-$2') : "";
            let cepFinal = addr.postcode || cepFormatado || "-";

            if (cepInputVal.length === 8 && bairroOficial !== "-") {
                document.getElementById('res-bairro').innerText = bairroOficial;
                document.getElementById('res-cep').innerText = cepOficial;
                document.getElementById('res-cidade').innerText = cidadeViaCEP;
            } else {
                document.getElementById('res-bairro').innerText = bairroMapa;
                document.getElementById('res-cidade').innerText = cidadeMapa;
                document.getElementById('res-cep').innerText = cepFinal;
            }
            
            atualizarMapa(lat, lon, true);
            document.getElementById('search-results').classList.remove('d-none');
        }

    function mostrarModalSelecao(itens) {
        const lista = document.getElementById('lista-enderecos');
        lista.innerHTML = ""; 
        itens.forEach(item => {
            const addr = item.address || {};
            const rua = addr.road || addr.street || item.display_name.split(',')[0];
            const bairro = addr.suburb || addr.neighbourhood || addr.city_district || "Bairro n√£o informado";
            const cidade = obterCidade(addr);
            const num = addr.house_number ? `<span class="badge-numero">N¬∫ ${addr.house_number}</span>` : "";
            
            const btn = document.createElement('button');
            btn.className = "list-group-item list-group-item-action";
            btn.innerHTML = `<div class="fw-bold">${num} ${rua}</div><div class="small text-muted"><span class="badge-bairro">${bairro}</span> - ${cidade}</div>`;
            btn.onclick = () => {
                const m = bootstrap.Modal.getInstance(document.getElementById('modalSelecao'));
                m.hide();
                
                const a = item.address || {};
                document.getElementById('res-bairro').innerText = a.suburb || a.neighbourhood || "-";
                document.getElementById('res-cidade').innerText = obterCidade(a);
                
                let cepInputVal = document.getElementById('cep').value.replace(/\D/g, '');
                let cepFormatado = cepInputVal.length === 8 ? cepInputVal.replace(/^(\d{5})(\d)/, '$1-$2') : "";
                document.getElementById('res-cep').innerText = a.postcode || cepFormatado || "-";
                
                let lat = parseFloat(item.lat), lon = parseFloat(item.lon);
                atualizarMapa(lat, lon, true);
                document.getElementById('search-results').classList.remove('d-none');
            };
            lista.appendChild(btn);
        });
        if (!modalSelecao) modalSelecao = new bootstrap.Modal(document.getElementById('modalSelecao'));
        modalSelecao.show();
    }

    function validarResultadoGeografico(item, cidadeEsperada) {
        const lat = parseFloat(item.lat);
        if (cidadeEsperada === "" || cidadeEsperada === "S√£o Paulo") { if (lat < -24.05) return false; }
        return true;
    }

    function atualizarMapa(lat, lon, zoom) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon], { draggable: true }).addTo(map);
        marker.setZIndexOffset(1000);
        if (zoom) map.setView([lat, lon], 17);
        marker.on('dragend', (e) => {
            verificarPoligono(e.target.getLatLng().lat, e.target.getLatLng().lng);
            document.getElementById('res-log').innerText = "Localiza√ß√£o Ajustada (Pino)";
        });
        verificarPoligono(lat, lon);
    }

    function verificarPoligono(lat, lon) {
        if (!geoJsonData) return;
        const pt = turf.point([lon, lat]);
        let uvisEncontrada = "Fora da √°rea mapeada", daEncontrada = "-", emailUvis = "-", achouUBS = false, nomeUBS = "N√£o identificada";

        turf.featureEach(geoJsonData, (f) => {
            if (turf.booleanPointInPolygon(pt, f)) {
                const props = f.properties;
                exibirDetalhesRegiao(props); 
                for (const [key, val] of Object.entries(props)) {
                    const k = key.toLowerCase();
                    if (k.includes('uvis') && !k.includes('endereco') && !k.includes('logradouro')) {
                        if (k.includes('nome') || k.includes('nm')) uvisEncontrada = val;
                        else if (uvisEncontrada === "Fora da √°rea mapeada" && isNaN(val)) uvisEncontrada = val;
                    }
                    if ((k.includes('da') || k.includes('distrito')) && isNaN(val)) daEncontrada = val;
                    if (k.includes('email')) emailUvis = val;
                }
            }
        });

        if (geoJsonUBS) {
            turf.featureEach(geoJsonUBS, (f) => {
                if (achouUBS) return; 
                if (turf.booleanPointInPolygon(pt, f)) {
                     const p = f.properties;
                     for (const [key, val] of Object.entries(p)) {
                         if (key.match(/nome|name|fantasia/i)) {
                             nomeUBS = val;
                             achouUBS = true;
                             break;
                         }
                     }
                     if (!achouUBS && (p.description)) { nomeUBS = p.description; achouUBS = true; }
                }
            });
        }

        const divUbs = document.getElementById('ubs-result-card');
        const txtUbs = document.getElementById('res-ubs');
        if (uvisEncontrada !== "Fora da √°rea mapeada") {
            document.getElementById('res-uvis').innerText = uvisEncontrada;
            document.getElementById('res-da').innerText = daEncontrada;
            document.getElementById('res-email').innerText = emailUvis;
            divUbs.classList.remove('d-none');
            if (achouUBS) {
                txtUbs.innerText = nomeUBS;
                txtUbs.className = "fw-bold text-success";
            } else {
                txtUbs.innerText = "Endere√ßo em √°rea mapeada, mas sem UBS vinculada";
                txtUbs.className = "fw-bold text-warning";
            }
        } else {
            document.getElementById('res-uvis').innerText = "Fora da √°rea mapeada";
            ['res-da','res-email'].forEach(id => document.getElementById(id).innerText = "-");
            ['ubs-result-card','region-details'].forEach(id => document.getElementById(id).classList.add('d-none'));
        }
        document.getElementById('search-results').classList.remove('d-none');
    }

    function exibirDetalhesRegiao(props) {
        const container = document.getElementById('detail-content');
        let htmlContent = "";
        const ignorar = ['name', 'description', 'geometry', 'type', 'styleUrl', 'styleHash', 'styleMap', 'stroke', 'stroke-width', 'stroke-opacity', 'fill', 'fill-opacity', 'icon'];
        for (const [key, value] of Object.entries(props)) {
            if (!ignorar.includes(key)) htmlContent += `<div style="margin-bottom: 5px;"><strong>${key}:</strong> ${value}</div>`;
        }
        container.innerHTML = htmlContent;
        document.getElementById('region-details').classList.remove('d-none');
    }

    function copiar(btn, id) {
        navigator.clipboard.writeText(document.getElementById(id).innerText).then(() => {
            let original = btn.innerHTML; btn.innerHTML = "‚úì"; setTimeout(() => btn.innerHTML = original, 1500);
        });
    }

    function copiarTextoDetalhes(btn) {
        navigator.clipboard.writeText(document.getElementById('detail-content').innerText).then(() => {
            let original = btn.innerText; btn.innerText = "Copiado!"; setTimeout(() => btn.innerText = original, 2000);
        });
    }

    function alternarVisualizacao() {
        const m = document.querySelector('.col-md-3'), b = document.getElementById('toggle-view-btn');
        m.classList.toggle('hidden');
        b.innerHTML = m.classList.contains('hidden') ? "üìù" : "üó∫Ô∏è";
        setTimeout(() => map.invalidateSize(), 200);
    }

    document.addEventListener('DOMContentLoaded', () => {
         const inputs = ['cep', 'logradouro', 'numero'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', (e) => {
                     limparDadosVisuais();
                    if (marker) { map.removeLayer(marker); marker = null; }

                     if (id === 'logradouro') document.getElementById('cep').value = "";
                    if (id === 'cep') {
                        let v = e.target.value.replace(/\D/g, '');
                        if (v.length > 5) v = v.replace(/^(\d{5})(\d)/, '$1-$2');
                        e.target.value = v;
                        if (v.replace(/\D/g, '').length === 8) preencherEnderecoPeloCEP(v.replace(/\D/g, ''));
                    }
                });
            }
        });

        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', function (e) { if (e.key === 'Enter') buscarEndereco(); });
        });
    });
</script>
</body>
</html>

