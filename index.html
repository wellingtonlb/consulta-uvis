<script>
    const map = L.map('map').setView([-23.5505, -46.6333], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    let geoJsonData = null;  
    let geoJsonUBS = null;   
    let marker = null;
    let geoJsonLayer = null;
    let bairroCache = ""; 

     const distinctColors = [
        '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', 
        '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', 
        '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', 
        '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'
    ];

    function getColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        return distinctColors[Math.abs(hash) % distinctColors.length];
    }

    function styleFeature(feature) {
        let nomeParaCor = "default";
         for (const [key, value] of Object.entries(feature.properties)) {
            if (key.toLowerCase().includes('uvis')) {
                nomeParaCor = value;
                break;
            }
        }
        return {
            fillColor: getColor(String(nomeParaCor)),
            weight: 1,
            opacity: 1,
            color: '#888',
            fillOpacity: 0.1 
        };
    }

     function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({ weight: 3, color: '#666', fillOpacity: 0.3 });
        layer.bringToFront();
        if (marker) marker.setZIndexOffset(1000);
    }

    function resetHighlight(e) {
        geoJsonLayer.resetStyle(e.target);
    }

    function onFeatureClick(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
         atualizarMapa(lat, lng, false);
         limparDadosEndereco();
    }

    function limparDadosEndereco() {
        document.getElementById('res-log').innerText = "Selecionado no Mapa";
        document.getElementById('res-cep').innerText = "-";
        document.getElementById('res-bairro').innerText = "-";
    }

    function onEachFeature(feature, layer) {
        let nomeDisplay = "";
        for (const [key, value] of Object.entries(feature.properties)) {
            if (key.toLowerCase().includes('uvis')) {
                nomeDisplay = value;
                break;
            }
        }
        layer.bindTooltip(nomeDisplay, {
            permanent: false, 
            direction: "center",
            className: "bg-transparent border-0 text-dark fw-bold"
        });
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: onFeatureClick
        });
    }

 
    fetch('./dados.json')
        .then(r => r.json())
        .then(data => {
            geoJsonData = data;
            geoJsonLayer = L.geoJson(data, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            if(geoJsonLayer.getBounds().isValid()){
                map.fitBounds(geoJsonLayer.getBounds());
            }
            console.log("✅ Sucesso: Base UVIS carregada.");
        })
        .catch(err => {
            console.error(err);
            alert("❌ ERRO CRÍTICO: Não foi possível carregar 'dados.json'. O mapa ficará vazio.");
        });

     fetch('./Territorios_UBS.geojson')
        .then(r => {
            if(!r.ok) throw new Error("Arquivo não encontrado ou erro HTTP");
            return r.json();
        })
        .then(data => {
            geoJsonUBS = data;
            console.log("✅ Sucesso: Base UBS carregada (Memória).");
        })
        .catch(err => {
            console.warn("⚠️ Aviso: Falha ao carregar 'Territorios_UBS.geojson'.", err);
            console.log("Dica: Se você apenas renomeou .kml para .geojson, isso não funciona. Use um conversor online.");
         });


     document.getElementById('cep').addEventListener('blur', function() {
        let cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        bairroCache = data.bairro;
                    }
                });
        }
    });

    function buscarEndereco() {
        const rua = document.getElementById('logradouro').value;
        const num = document.getElementById('numero').value;
        const cepInput = document.getElementById('cep').value;

        if (!rua) { alert("Preencha o logradouro."); return; }

        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('search-results').classList.add('d-none');
        document.getElementById('region-details').classList.add('d-none');
        document.getElementById('ubs-result-card').classList.add('d-none');

        const query = `${rua}, ${num}, São Paulo, Brasil`;
        
         fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}&limit=1&email=wellingtonlb22@outlook.com`)
            .then(res => {
                if (!res.ok) throw new Error("Erro HTTP: " + res.status);
                return res.json();
            })
            .then(data => {
                document.getElementById('loading').classList.add('d-none');
                
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    document.getElementById('res-log').innerText = rua + (num ? `, ${num}` : '');
                    
                    let cepEncontrado = cepInput;
                    if (!cepEncontrado && data[0].address && data[0].address.postcode) {
                        cepEncontrado = data[0].address.postcode;
                    }
                    document.getElementById('res-cep').innerText = cepEncontrado || "Não informado";
                    
                    let bairroMapa = "";
                    if (data[0].address) {
                        bairroMapa = data[0].address.suburb || data[0].address.neighbourhood || data[0].address.residential || "";
                    }
                    const bairroFinal = bairroCache || bairroMapa || "Não identificado";
                    document.getElementById('res-bairro').innerText = bairroFinal;

                     atualizarMapa(lat, lon, true);
                } else {
                    alert("Endereço não encontrado pelo localizador.");
                }
            })
            .catch((err) => {
                document.getElementById('loading').classList.add('d-none');
                console.error(err);
                alert("Ocorreu um erro ao buscar o endereço. Tente novamente.");
            });
    }

    function atualizarMapa(lat, lon, darZoom = false) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon], { draggable: true }).addTo(map);
        marker.setZIndexOffset(1000);
        
        if (darZoom) {
            map.setView([lat, lon], 16);
        }
        
        marker.on('dragend', function(e) {
            verificarPoligono(e.target.getLatLng().lat, e.target.getLatLng().lng);
        });

        verificarPoligono(lat, lon);
    }

    function verificarPoligono(lat, lon) {
         if (!geoJsonData) return;

        const ponto = turf.point([lon, lat]);
        
         let featureUVIS = null;
        turf.featureEach(geoJsonData, function (feat) {
            if (turf.booleanPointInPolygon(ponto, feat)) {
                featureUVIS = feat;
            }
        });

         let nomeUBS = "Não identificada";
        let achouUBS = false;
        
        if (geoJsonUBS) {
            turf.featureEach(geoJsonUBS, function (feat) {
                 if (!achouUBS && turf.booleanPointInPolygon(ponto, feat)) {
                     const p = feat.properties;
                     nomeUBS = p.Name || p.name || p.NOME || p.NO_FANTASIA || p.description || "Sem Nome";
                    achouUBS = true;
                }
            });
        }

         const divUbs = document.getElementById('ubs-result-card');
        const txtUbs = document.getElementById('res-ubs');
        
         if (geoJsonUBS && featureUVIS) {
            divUbs.classList.remove('d-none');
            if (achouUBS) {
                txtUbs.innerText = nomeUBS;
                txtUbs.classList.remove('text-muted');
                txtUbs.classList.add('text-success');
            } else {
                txtUbs.innerText = "Fora da área de cobertura das UBS mapeadas";
                txtUbs.classList.add('text-muted');
                txtUbs.classList.remove('text-success');
            }
        } else {
             divUbs.classList.add('d-none');
        }

          if (featureUVIS) {
            atualizarPainelResumo(featureUVIS.properties);
            exibirDetalhesRegiao(featureUVIS.properties);
            document.getElementById('search-results').classList.remove('d-none');
        } else {
              document.getElementById('res-uvis').innerText = "Fora da área mapeada";
            document.getElementById('res-da').innerText = "-";
            document.getElementById('res-email').innerText = "-";
            document.getElementById('search-results').classList.remove('d-none');
            document.getElementById('region-details').classList.add('d-none');
            divUbs.classList.add('d-none');
        }
    }

     function atualizarPainelResumo(props) {
        let candidatosUVIS = [];
        let candidatosDA = [];
        let emailFinal = "-";
        let foundSpecificEmail = false;

        for (const [key, value] of Object.entries(props)) {
            const k = key.toLowerCase();
            const v = String(value).trim();

            if (k.includes('uvis')) {
                let pontos = 0;
                if (k.includes('nome') || k.includes('nm') || k.includes('desc')) pontos += 20; 
                if (isNaN(v)) pontos += 10; 
                candidatosUVIS.push({ valor: v, pontos: pontos });
            }

            if (k.includes('da') || k.includes('distrito')) {
                let pontos = 0;
                if (k.includes('nome') || k.includes('nm')) pontos += 20;
                candidatosDA.push({ valor: v, pontos: pontos });
            }

            if (k === 'email') {
                emailFinal = v;
                foundSpecificEmail = true;
            } else if (k.includes('email') && !foundSpecificEmail) {
                emailFinal = v;
            }
        }

        candidatosUVIS.sort((a, b) => b.pontos - a.pontos);
        candidatosDA.sort((a, b) => b.pontos - a.pontos);

        document.getElementById('res-uvis').innerText = candidatosUVIS.length > 0 ? candidatosUVIS[0].valor : "Não identificado";
        document.getElementById('res-da').innerText = candidatosDA.length > 0 ? candidatosDA[0].valor : "Não identificado";
        document.getElementById('res-email').innerText = emailFinal;
    }

    function exibirDetalhesRegiao(props) {
        const container = document.getElementById('detail-content');
        let htmlContent = "";
        const ignorar = ['name', 'description', 'geometry', 'type', 'styleUrl', 'styleHash', 'styleMap', 'stroke', 'stroke-width', 'stroke-opacity', 'fill', 'fill-opacity', 'icon'];

        for (const [key, value] of Object.entries(props)) {
            if (!ignorar.includes(key)) {
                htmlContent += `<div style="margin-bottom: 5px;"><strong>${key}:</strong> ${value}</div>`;
            }
        }
        container.innerHTML = htmlContent;
        document.getElementById('region-details').classList.remove('d-none');
    }

    function copiar(btn, elementId) {
        const texto = document.getElementById(elementId).innerText;
        navigator.clipboard.writeText(texto).then(() => {
            const originalHTML = btn.innerHTML;
            btn.classList.add('copied');
            btn.innerHTML = "✓";
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = originalHTML;
            }, 1500);
        });
    }

    function copiarTextoDetalhes(btn) {
        const texto = document.getElementById('detail-content').innerText;
        navigator.clipboard.writeText(texto).then(() => {
            const originalText = btn.innerText;
            btn.innerText = "Copiado!";
            setTimeout(() => {
                btn.innerText = originalText;
            }, 2000);
        });
    }
</script>
