<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Territ√≥rio UVIS</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { background-color: #f4f6f9; }
        .main-card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        #map { height: 85vh; width: 100%; border-radius: 8px; border: 1px solid #dee2e6; }
        
        .result-row { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: #fff; 
            border: 1px solid #e9ecef; 
            padding: 6px 10px; 
            border-radius: 6px; 
            margin-bottom: 6px;
        }
        
        .res-label { font-size: 0.7rem; color: #6c757d; text-transform: uppercase; font-weight: 700; display: block; }
        .res-value { font-size: 0.95rem; color: #212529; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        
        .res-value-multiline {
            font-size: 0.85rem;
            color: #212529;
            font-weight: 600;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.4;
        }

        .detail-card {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 5px solid #6610f2;
        }

        .detail-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #6610f2;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .detail-content {
            font-size: 0.8rem;
            color: #333;
            line-height: 1.6;
        }

        .btn-copy { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            color: #495057; 
            width: 30px; 
            height: 30px; 
            border-radius: 4px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            transition: all 0.2s ease;
            margin-left: 8px;
            flex-shrink: 0;
        }
        .btn-copy:hover { background-color: #e2e6ea; color: #0d6efd; border-color: #cbd5e0; }
        .btn-copy.copied { background-color: #198754; color: white; border-color: #198754; }

        .border-uvis { border-left: 3px solid #0d6efd; }
        .border-da { border-left: 3px solid #198754; }
    </style>
</head>
<body class="py-3">

<div class="container-fluid px-3">
    
    <div class="row g-3">
        <div class="col-md-3 d-flex flex-column" style="max-height: 95vh; overflow-y: auto;">
            
            <div class="text-center mb-3">
                <h5 class="fw-bold text-primary mb-0">Localizador UVIS e DA</h5>
            </div>

            <div class="card main-card mb-3">
                <div class="card-body p-3">
                    <div class="mb-2">
                        <label class="form-label small fw-bold text-secondary mb-1">CEP</label>
                        <input type="text" class="form-control form-control-sm" id="cep" placeholder="00000-000" maxlength="9">
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-8">
                            <label class="form-label small fw-bold text-secondary mb-1">Logradouro</label>
                            <input type="text" class="form-control form-control-sm" id="logradouro" placeholder="Nome da rua">
                        </div>
                        <div class="col-4">
                            <label class="form-label small fw-bold text-secondary mb-1">N√∫mero</label>
                            <input type="text" class="form-control form-control-sm" id="numero" placeholder="N¬∫">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm w-100 fw-bold" onclick="buscarEndereco()">üîç CONSULTAR</button>
                </div>
            </div>

            <div id="search-results" class="d-none animate__animated animate__fadeIn">
                <h6 class="fw-bold text-secondary small mb-2">ENDERE√áO LOCALIZADO</h6>
                
                <div class="result-row border-uvis">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">UVIS (Refer√™ncia)</span>
                        <span id="res-uvis" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-uvis')">üìã</button>
                </div>

                <div class="result-row border-da">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Distrito Administrativo</span>
                        <span id="res-da" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-da')">üìã</button>
                </div>

                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Endere√ßo Pesquisado</span>
                        <span id="res-log" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-log')">üìã</button>
                </div>

                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Bairro</span>
                        <span id="res-bairro" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-bairro')">üìã</button>
                </div>

                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">CEP</span>
                        <span id="res-cep" class="res-value">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-cep')">üìã</button>
                </div>

                <div class="result-row">
                    <div style="flex: 1; min-width: 0;">
                        <span class="res-label">Contatos / Email</span>
                        <span id="res-email" class="res-value-multiline">-</span>
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-email')">üìã</button>
                </div>
            </div>

            <div id="ubs-result-card" class="d-none mb-3 p-3 bg-white border border-success rounded shadow-sm animate__animated animate__fadeIn" style="border-left-width: 5px !important;">
                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">
                    üè• UBS de Refer√™ncia
                </small>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <div id="res-ubs" class="h6 fw-bold text-success mb-0">
                        -
                    </div>
                    <button class="btn-copy" onclick="copiar(this, 'res-ubs')">üìã</button>
                </div>
            </div>


            <div id="region-details" class="detail-card d-none animate__animated animate__fadeInUp">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="detail-title mb-0">FICHA T√âCNICA DA UNIDADE</span>
                    <button class="btn btn-sm btn-outline-secondary py-0" style="font-size: 0.7rem;" onclick="copiarTextoDetalhes(this)">Copiar Tudo</button>
                </div>
                <div id="detail-content" class="detail-content">-</div>
            </div>

            <div id="loading" class="text-center d-none py-3">
                <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                <span class="ms-2 small text-muted">Processando...</span>
            </div>

            <footer class="mt-auto pt-3 text-center">
                <a href="privacidade.html" class="small text-muted text-decoration-none">Pol√≠tica de Privacidade</a>
            </footer>
        </div>
        
        <div class="col-md-9">
            <div id="map"></div>
            <p class="text-muted small mt-1 text-end mb-0">
                <span class="badge bg-light text-dark border">Dica</span> Arraste o pino para ajustar. Clique em qualquer √°rea colorida para ver a ficha t√©cnica.
            </p>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

```html
<script>
    const map = L.map('map').setView([-23.5505, -46.6333], 11);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    let geoJsonData = null;  
    let geoJsonUBS = null;  
    let marker = null;
    let geoJsonLayer = null;
    let bairroCache = ""; 

     const distinctColors = [
        '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', 
        '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', 
        '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', 
        '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'
    ];

    function getColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % distinctColors.length;
        return distinctColors[index];
    }

    function styleFeature(feature) {
        let nomeParaCor = "default";
         for (const [key, value] of Object.entries(feature.properties)) {
            if (key.toLowerCase().includes('uvis')) {
                nomeParaCor = value;
                break;
            }
        }
        
        const baseColor = getColor(String(nomeParaCor));

        return {
            fillColor: baseColor,
            weight: 1,
            opacity: 1,
            color: '#888',
            dashArray: '',
            fillOpacity: 0.1 
        };
    }

    function highlightFeature(e) {
        const layer = e.target;
        layer.setStyle({
            weight: 3,
            color: '#666',
            fillOpacity: 0.3 
        });
        layer.bringToFront();
        if (marker) marker.setZIndexOffset(1000);
    }

    function resetHighlight(e) {
        geoJsonLayer.resetStyle(e.target);
    }

    function onFeatureClick(e) {
        map.fitBounds(e.target.getBounds());
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
         atualizarMapa(lat, lng);
    }

    function onEachFeature(feature, layer) {
        let nomeDisplay = "";
        for (const [key, value] of Object.entries(feature.properties)) {
            if (key.toLowerCase().includes('uvis')) {
                nomeDisplay = value;
                break;
            }
        }
        layer.bindTooltip(nomeDisplay, {
            permanent: false, 
            direction: "center",
            className: "bg-transparent border-0 text-dark fw-bold"
        });

        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: onFeatureClick
        });
    }

     Promise.all([
        fetch('./dados.json').then(r => r.json()),
        fetch('./Territorios_UBS.geojson').then(r => r.json())
    ])
    .then(([dataUVIS, dataUBS]) => {
         geoJsonData = dataUVIS;
        geoJsonLayer = L.geoJson(dataUVIS, {
            style: styleFeature,
            onEachFeature: onEachFeature
        }).addTo(map);

        if(geoJsonLayer.getBounds().isValid()){
            map.fitBounds(geoJsonLayer.getBounds());
        }

         geoJsonUBS = dataUBS;
        console.log("Todas as bases carregadas (UVIS + UBS).");
    })
    .catch(err => {
        console.error(err);
        alert("Erro ao carregar arquivos GeoJSON (dados.json ou Territorios_UBS.geojson). Verifique os nomes.");
    });

     document.getElementById('cep').addEventListener('blur', function() {
        let cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro;
                        bairroCache = data.bairro;
                    }
                });
        }
    });

    function buscarEndereco() {
        const rua = document.getElementById('logradouro').value;
        const num = document.getElementById('numero').value;
        const cepInput = document.getElementById('cep').value;

        if (!rua) { alert("Preencha o logradouro."); return; }

        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('search-results').classList.add('d-none');
        document.getElementById('region-details').classList.add('d-none');
        document.getElementById('ubs-result-card').classList.add('d-none');  

        const query = `${rua}, ${num}, S√£o Paulo, Brasil`;
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(query)}&limit=1`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('d-none');
                
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    document.getElementById('res-log').innerText = rua + (num ? `, ${num}` : '');
                    let cepEncontrado = cepInput;
                    if (!cepEncontrado && data[0].address && data[0].address.postcode) {
                        cepEncontrado = data[0].address.postcode;
                    }
                    document.getElementById('res-cep').innerText = cepEncontrado || "N√£o informado";
                    
                    let bairroMapa = "";
                    if (data[0].address) {
                        bairroMapa = data[0].address.suburb || data[0].address.neighbourhood || data[0].address.residential || data[0].address.city_district || "";
                    }
                    const bairroFinal = bairroCache || bairroMapa || "N√£o identificado";
                    document.getElementById('res-bairro').innerText = bairroFinal;

                    atualizarMapa(lat, lon);
                } else {
                    alert("Endere√ßo n√£o encontrado.");
                }
            })
            .catch(() => {
                document.getElementById('loading').classList.add('d-none');
                alert("Erro de conex√£o.");
            });
    }

    function atualizarMapa(lat, lon) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lon], { draggable: true }).addTo(map);
        marker.setZIndexOffset(1000);
        map.setView([lat, lon], 16);
        
        marker.on('dragend', function(e) {
            verificarPoligono(e.target.getLatLng().lat, e.target.getLatLng().lng);
        });

        verificarPoligono(lat, lon);
    }

     function verificarPoligono(lat, lon) {
        if (!geoJsonData || !geoJsonUBS) return;  

        const ponto = turf.point([lon, lat]);
        
         let featureUVIS = null;
        turf.featureEach(geoJsonData, function (feat) {
            if (turf.booleanPointInPolygon(ponto, feat)) {
                featureUVIS = feat;
            }
        });

         let nomeUBS = "N√£o localizada na base";
        let achouUBS = false;
        
        turf.featureEach(geoJsonUBS, function (feat) {
             if (!achouUBS && turf.booleanPointInPolygon(ponto, feat)) {
                 const p = feat.properties;
                nomeUBS = p.Name || p.name || p.NOME || p.NO_FANTASIA || p.description || "Sem Nome";
                achouUBS = true;
            }
        });

         const divUbs = document.getElementById('ubs-result-card');
        const txtUbs = document.getElementById('res-ubs');
        
        if (achouUBS) {
            txtUbs.innerText = nomeUBS;
            txtUbs.classList.remove('text-muted');
            txtUbs.classList.add('text-success');
        } else {
            txtUbs.innerText = "Fora da √°rea de cobertura das UBS mapeadas";
            txtUbs.classList.add('text-muted');
            txtUbs.classList.remove('text-success');
        }
        divUbs.classList.remove('d-none');


         if (featureUVIS) {
            atualizarPainelResumo(featureUVIS.properties);
            exibirDetalhesRegiao(featureUVIS.properties);
            document.getElementById('search-results').classList.remove('d-none');
        } else {
             document.getElementById('res-uvis').innerText = "Fora da √°rea mapeada";
            document.getElementById('res-da').innerText = "-";
            document.getElementById('res-email').innerText = "-";
            document.getElementById('search-results').classList.remove('d-none');
            document.getElementById('region-details').classList.add('d-none');
        }
    }

    function atualizarPainelResumo(props) {
        let candidatosUVIS = [];
        let candidatosDA = [];
        let emailFinal = "-";
        let foundSpecificEmail = false;

        for (const [key, value] of Object.entries(props)) {
            const k = key.toLowerCase();
            const v = String(value).trim();

            if (k.includes('uvis')) {
                let pontos = 0;
                if (k.includes('nome') || k.includes('nm') || k.includes('desc')) pontos += 20; 
                if (isNaN(v)) pontos += 10; 
                if (k.includes('cod') || k.includes('id')) pontos -= 10; 
                candidatosUVIS.push({ valor: v, pontos: pontos });
            }

            if (k.includes('da') || k.includes('distrito')) {
                let pontos = 0;
                if (k.includes('nome') || k.includes('nm') || k.includes('desc')) pontos += 20;
                if (isNaN(v)) pontos += 10;
                if (k.includes('cod') || k.includes('id')) pontos -= 10;
                candidatosDA.push({ valor: v, pontos: pontos });
            }

            if (k === 'email') {
                emailFinal = v;
                foundSpecificEmail = true;
            } else if (k.includes('email') && !foundSpecificEmail) {
                emailFinal = v;
            }
        }

        candidatosUVIS.sort((a, b) => b.pontos - a.pontos);
        candidatosDA.sort((a, b) => b.pontos - a.pontos);

        document.getElementById('res-uvis').innerText = candidatosUVIS.length > 0 ? candidatosUVIS[0].valor : "N√£o identificado";
        document.getElementById('res-da').innerText = candidatosDA.length > 0 ? candidatosDA[0].valor : "N√£o identificado";
        document.getElementById('res-email').innerText = emailFinal;
    }

    function exibirDetalhesRegiao(props) {
        const container = document.getElementById('detail-content');
        let htmlContent = "";
        
        const ignorar = ['name', 'description', 'geometry', 'type', 'styleUrl', 'styleHash', 'styleMap', 'stroke', 'stroke-width', 'stroke-opacity', 'fill', 'fill-opacity', 'icon'];

        for (const [key, value] of Object.entries(props)) {
            if (!ignorar.includes(key)) {
                htmlContent += `<div style="margin-bottom: 5px;"><strong>${key}:</strong> ${value}</div>`;
            }
        }

        container.innerHTML = htmlContent;
        document.getElementById('region-details').classList.remove('d-none');
    }

    function copiar(btn, elementId) {
        const texto = document.getElementById(elementId).innerText;
        navigator.clipboard.writeText(texto).then(() => {
            const originalHTML = btn.innerHTML;
            btn.classList.add('copied');
            btn.innerHTML = "‚úì";
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = originalHTML;
            }, 1500);
        });
    }

    function copiarTextoDetalhes(btn) {
        const texto = document.getElementById('detail-content').innerText;
        navigator.clipboard.writeText(texto).then(() => {
            const originalText = btn.innerText;
            btn.innerText = "Copiado!";
            setTimeout(() => {
                btn.innerText = originalText;
            }, 2000);
        });
    }
</script>

</body>
</html>


